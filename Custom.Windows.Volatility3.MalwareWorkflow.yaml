name: Custom.Windows.Volatility3.MalwareWorkflow
description: |
  Complete malware analysis workflow.
  Process tree, command lines, injection detection, network, DLLs.
  Based on SOCFortress Volatility 3 Cheatsheet Section 7.
author: https://www.linkedin.com/in/moussa-amine/
type: CLIENT

parameters:
  - name: MemoryDumpPath
    type: string
    description: Full path to the memory dump file
  
  - name: SuspiciousPID
    type: int
    default: 0
    description: Suspicious PID to focus analysis on (0 for all)
  
  - name: OutputFormat
    type: string
    default: "pretty"
    description: Output format (pretty, csv, json, jsonl)
  
  - name: QuietMode
    type: bool
    default: true
    description: Suppress progress messages
  
  - name: VolatilityPath
    type: string
    default: "C:\\ProgramData\\Volatility3\\Python\\Scripts\\vol.exe"
    description: Path to vol.exe

sources:
  - name: Step1_ProcessTree
    query: |
      LET args = if(
        condition=QuietMode,
        then=array(a=VolatilityPath, b="-f", c=MemoryDumpPath, d="-r", e=OutputFormat, f="-q", g="windows.pstree"),
        else=array(a=VolatilityPath, b="-f", c=MemoryDumpPath, d="-r", e=OutputFormat, f="windows.pstree")
      )
      
      LET result = SELECT * FROM execve(argv=args, length=10000000)
      
      SELECT 
        'Step1_ProcessTree' as WorkflowStep,
        'windows.pstree' as Plugin,
        Stdout as Output
      FROM result

  - name: Step2_CommandLines
    query: |
      LET args = if(
        condition=QuietMode,
        then=array(a=VolatilityPath, b="-f", c=MemoryDumpPath, d="-r", e=OutputFormat, f="-q", g="windows.cmdline"),
        else=array(a=VolatilityPath, b="-f", c=MemoryDumpPath, d="-r", e=OutputFormat, f="windows.cmdline")
      )
      
      LET result = SELECT * FROM execve(argv=args, length=10000000)
      
      SELECT 
        'Step2_CommandLines' as WorkflowStep,
        'windows.cmdline' as Plugin,
        Stdout as Output
      FROM result

  - name: Step3_InjectedCode
    query: |
      LET base_args = array(a=VolatilityPath, b="-f", c=MemoryDumpPath, d="-r", e=OutputFormat)
      
      LET quiet_flag = if(condition=QuietMode, then=array(a="-q"), else=array())
      
      LET pid_args = if(
        condition=SuspiciousPID > 0,
        then=array(a="windows.malware.malfind", b="--pid", c=str(str=SuspiciousPID)),
        else=array(a="windows.malware.malfind")
      )
      
      LET args = base_args + quiet_flag + pid_args
      
      LET result = SELECT * FROM execve(argv=args, length=10000000)
      
      SELECT 
        'Step3_InjectedCode' as WorkflowStep,
        'windows.malware.malfind' as Plugin,
        SuspiciousPID as TargetPID,
        Stdout as Output
      FROM result

  - name: Step4_NetworkConnections
    query: |
      LET args = if(
        condition=QuietMode,
        then=array(a=VolatilityPath, b="-f", c=MemoryDumpPath, d="-r", e=OutputFormat, f="-q", g="windows.netscan"),
        else=array(a=VolatilityPath, b="-f", c=MemoryDumpPath, d="-r", e=OutputFormat, f="windows.netscan")
      )
      
      LET result = SELECT * FROM execve(argv=args, length=10000000)
      
      SELECT 
        'Step4_NetworkConnections' as WorkflowStep,
        'windows.netscan' as Plugin,
        Stdout as Output
      FROM result

  - name: Step5_LoadedDLLs
    query: |
      LET base_args = array(a=VolatilityPath, b="-f", c=MemoryDumpPath, d="-r", e=OutputFormat)
      
      LET quiet_flag = if(condition=QuietMode, then=array(a="-q"), else=array())
      
      LET pid_args = if(
        condition=SuspiciousPID > 0,
        then=array(a="windows.dlllist", b="--pid", c=str(str=SuspiciousPID)),
        else=array(a="windows.dlllist")
      )
      
      LET args = base_args + quiet_flag + pid_args
      
      LET result = SELECT * FROM execve(argv=args, length=10000000)
      
      SELECT 
        'Step5_LoadedDLLs' as WorkflowStep,
        'windows.dlllist' as Plugin,
        SuspiciousPID as TargetPID,
        Stdout as Output
      FROM result

  - name: Step6_UnlinkedDLLs
    query: |
      LET base_args = array(a=VolatilityPath, b="-f", c=MemoryDumpPath, d="-r", e=OutputFormat)
      
      LET quiet_flag = if(condition=QuietMode, then=array(a="-q"), else=array())
      
      LET pid_args = if(
        condition=SuspiciousPID > 0,
        then=array(a="windows.malware.ldrmodules", b="--pid", c=str(str=SuspiciousPID)),
        else=array(a="windows.malware.ldrmodules")
      )
      
      LET args = base_args + quiet_flag + pid_args
      
      LET result = SELECT * FROM execve(argv=args, length=10000000)
      
      SELECT 
        'Step6_UnlinkedDLLs' as WorkflowStep,
        'windows.malware.ldrmodules' as Plugin,
        SuspiciousPID as TargetPID,
        Stdout as Output
      FROM result